using DRadoaica.Antimalware.SDK;
using DRadoaica.Antimalware.SDK.Models;
using FakeItEasy;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Threading;

namespace DRadoaica.Antimalware.Tests
{
    [TestClass]
    public class AntimalwareTests
    {
        [TestMethod]
        public void AntimalwareMock_PubSub_ConsumeEvent()
        {
            // arrange
            IAntimalware antimalware = new AntimalwareMock();
            var antimalwareConsumerFake = A.Fake<IAntimalwareConsumer>();
            A.CallTo(() => antimalwareConsumerFake.ConsumeEvent(A<AntimalwareEvent>.Ignored))
                .Invokes((AntimalwareEvent antimalwareEvent) => { Console.WriteLine(antimalwareEvent.Message); });
            antimalware.SubscribeToEvents(antimalwareConsumerFake);
            //

            // act
            antimalware.StartScan();
            Thread.Sleep(TimeSpan.FromSeconds(9));
            antimalware.StopScan();
            Thread.Sleep(TimeSpan.FromSeconds(2));
            //

            // assert
            A.CallTo(() => antimalwareConsumerFake.ConsumeEvent(A<AntimalwareEvent>.Ignored)).MustHaveHappened(Repeated.AtLeast.Once);
            //
        }
    }
}
