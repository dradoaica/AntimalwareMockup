using System;
using System.Configuration;

namespace DRadoaica.Antimalware.SDK.Utils
{
    public static class AppConfigHelper
    {
        private const string REST_API_URL_APP_SETTINGS = "RESTApiUrl";
        private const string SIGNALR_URL_APP_SETTINGS = "SignalRUrl";

        public static string RESTApiUrl
        {
            get
            {
                return GetAppSetting<string>(REST_API_URL_APP_SETTINGS);
            }
        }
        public static string SignalRUrl
        {
            get
            {
                return GetAppSetting<string>(SIGNALR_URL_APP_SETTINGS);
            }
        }

        private static string GetAppSetting(string key, bool considerEmptyOrNullAsMissing = true)
        {
            string ret = ConfigurationManager.AppSettings[key];
            if (considerEmptyOrNullAsMissing && string.IsNullOrWhiteSpace(ret))
                throw new ApplicationException(string.Format("App setting \"{0}\" cannot be empty!", key));

            return ret;
        }

        public static T GetAppSetting<T>(string key, bool considerEmptyOrNullAsMissing = true)
        {
            if (key == null) throw new ArgumentNullException("key");

            Type type = typeof(T);
            object value = null;
            T ret = default(T);
            string appSetting = GetAppSetting(key, considerEmptyOrNullAsMissing);
            if (!string.IsNullOrWhiteSpace(appSetting))
                try
                {
                    if (type == typeof(bool))
                        value = "true".Equals(appSetting, StringComparison.InvariantCultureIgnoreCase);
                    else
                        value = appSetting;

                    ret = (T)Convert.ChangeType(value, type);
                }
                catch (Exception e)
                {
                    throw new ApplicationException(
                        string.Format(
                            "App setting \"{0}\" cannot be changed to requested type \"{1}\".",
                            key,
                            type.FullName
                        ),
                        e
                    );
                }

            return ret;
        }
    }
}
