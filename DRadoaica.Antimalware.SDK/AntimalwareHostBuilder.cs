using DRadoaica.Antimalware.SDK.Infrastructure.Handlers;
using DRadoaica.Antimalware.SDK.Infrastructure.IoC;
using DRadoaica.Antimalware.SDK.Utils;
using log4net;
using Microsoft.Owin.Cors;
using Microsoft.Owin.Hosting;
using Owin;
using Swashbuckle.Application;
using System.Net.Http.Formatting;
using System.Reflection;
using System.Web.Http;
using System.Web.Http.ExceptionHandling;
using Unity;
using Unity.Lifetime;

namespace DRadoaica.Antimalware.SDK
{
    public class AntimalwareHostBuilder
    {
        public class RESTApiStartup
        {
            public void Configuration(IAppBuilder appBuilder)
            {
                var containerWrapper = new IoCContainerWrapper();
                var config = new HttpConfiguration();
                config.MapHttpAttributeRoutes();
                config.DependencyResolver = new UnityDependencyResolver(containerWrapper.IocContainer);
                config.Services.Replace(typeof(IExceptionHandler), new GlobalExceptionHandler());
                config.Formatters.Clear();
                config.Formatters.Add(new JsonMediaTypeFormatter());
                config.EnableSwagger(c => { c.SingleApiVersion("v1", "DRadoaica.Antimalware.SDK"); })
                    .EnableSwaggerUi();
                appBuilder.UseWebApi(config);
            }
        }

        public class SignalRStartup
        {
            public void Configuration(IAppBuilder appBuilder)
            {
                appBuilder.UseCors(CorsOptions.AllowAll);
                appBuilder.MapSignalR();
            }
        }

        private static readonly ILog _logger = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);
        private readonly AntimalwareHost _host = new AntimalwareHost();
        private bool _useRESTApi;
        private bool _useSignalR;

        public AntimalwareHostBuilder UseRESTApi()
        {
            _useRESTApi = true;

            return this;
        }
        public AntimalwareHostBuilder UseSignalR()
        {
            _useSignalR = true;

            return this;
        }
        public AntimalwareHost Build()
        {
            // configure IoC
            var container = new UnityContainer();
            var containerWrapper = new IoCContainerWrapper();
            container.RegisterType<IAntimalware, AntimalwareMock>(new SingletonLifetimeManager());
            container.RegisterType<IAntimalwareConsumer, AntimalwareConsumer>(new SingletonLifetimeManager());
            containerWrapper.SetIocContainer(container);
            //

            // subscribe to the antimalware's events
            var antimalware = (IAntimalware)containerWrapper.IocContainer.Resolve(typeof(IAntimalware));
            antimalware.SubscribeToEvents((IAntimalwareConsumer)containerWrapper.IocContainer.Resolve(typeof(IAntimalwareConsumer)));
            //

            if (_useRESTApi)
            {
                _logger.InfoFormat("Start REST Api on '{0}'", AppConfigHelper.RESTApiUrl);
                _host.RESTApiHost = WebApp.Start<RESTApiStartup>(url: AppConfigHelper.RESTApiUrl);
            }
            if (_useSignalR)
            {
                _logger.InfoFormat("Start SignalR on '{0}'", AppConfigHelper.SignalRUrl);
                _host.SignalRHost = WebApp.Start<SignalRStartup>(url: AppConfigHelper.SignalRUrl);
            }

            return _host;
        }
    }
}
