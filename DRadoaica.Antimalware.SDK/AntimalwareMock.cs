using System;
using System.Collections.Generic;
using System.Threading;
using DRadoaica.Antimalware.SDK.Models;
using PubSub;

namespace DRadoaica.Antimalware.SDK
{
    public class AntimalwareMock : IAntimalware
    {
        private readonly object _obj = new object();
        private readonly Hub _hub = Hub.Default;
        private CancellationTokenSource _scanTokenSource = null;
        private bool _isScanningEnabled = true;

        public AntimalwareMock()
        {
            // real-time scanning
            new Thread(
            () =>
            {
                while (true)
                {
                    if (IsScanningEnabled)
                    {
                        // TODO: mock real-time scanning
                    }
                }
            }).Start();
        }

        public bool IsScanningEnabled
        {
            get
            {
                lock (_obj)
                {
                    return _isScanningEnabled;
                }
            }
        }

        public void DisableScanning()
        {
            lock (_obj)
            {
                _isScanningEnabled = false;
            }
        }
        public void EnableScanning()
        {
            lock (_obj)
            {
                _isScanningEnabled = true;
            }
        }
        public StartScanResult StartScan()
        {
            lock (_obj)
            {
                if (_scanTokenSource != null)
                {
                    return new StartScanResult { IsError = true, Message = "Scanning already in progress!" };
                }
                else
                {
                    _scanTokenSource = new CancellationTokenSource();
                    new Thread(
                    () =>
                    {
                        try
                        {
                            _hub.Publish(new AntimalwareEvent { Message = $"Scan successfully started at {DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss")}" });

                            var rnd = new Random();

                            int noOfSeconds = rnd.Next(10, 30);
                            _scanTokenSource.Token.WaitHandle.WaitOne(noOfSeconds * 1000);

                            if (_scanTokenSource.IsCancellationRequested)
                                _hub.Publish(new AntimalwareEvent { Message = $"Scan forcefully stopped at {DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss")}" });
                            else
                                _hub.Publish(new AntimalwareEvent { Message = $"Scan successfully finished at {DateTime.Now.ToString("MM/dd/yyyy HH:mm:ss")}" });

                            var threats = new List<Threat>();
                            int noOfThreats = rnd.Next(0, noOfSeconds * 10);
                            for (int i = 0; i < noOfThreats; i++)
                                threats.Add(new Threat
                                {
                                    Name = $"Trojan_{Guid.NewGuid()}",
                                    Path = $"C:\\Windows\\System32\\{Guid.NewGuid()}"
                                });

                            _hub.Publish(new AntimalwareEvent
                            {
                                Message = $"{noOfThreats} threats were found during the scan",
                                Threats = threats.ToArray()
                            });
                        }
                        catch (Exception e)
                        {
                            throw e;
                        }
                        finally
                        {
                            _scanTokenSource = null;
                        }

                    }).Start();

                    return new StartScanResult { IsError = false, Message = "Success" };
                }
            }
        }
        public StopScanResult StopScan()
        {
            lock (_obj)
            {
                if (_scanTokenSource != null)
                    _scanTokenSource.Cancel();

                return new StopScanResult { IsError = false, Message = "Success" };
            }
        }
        public void SubscribeToEvents(IAntimalwareConsumer consumer)
        {
            _hub.Subscribe<AntimalwareEvent>(consumer, antimalwareEvent =>
            {
                consumer.ConsumeEvent(antimalwareEvent);
            });
        }
        public void UnsubscribeFromEvents(IAntimalwareConsumer consumer)
        {
            _hub.Unsubscribe<AntimalwareEvent>(consumer);
        }
    }
}
