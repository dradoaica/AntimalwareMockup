using DRadoaica.Antimalware.SDK.Api;
using DRadoaica.Antimalware.SDK.Infrastructure.Json;
using DRadoaica.Antimalware.SDK.Models;
using DRadoaica.Antimalware.SDK.Utils;
using log4net;
using System;
using System.Collections.Generic;
using System.IO;
using System.Reflection;

namespace DRadoaica.Antimalware.SDK
{
    public class AntimalwareConsumer : IAntimalwareConsumer
    {
        private static readonly ILog _logger = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);
        private const string REPO_FILE_NAME = "events.json";

        public PushNotificationSlot PushNotificationSlot { get; set; }

        private void PushNotificationViaWebHook(AntimalwareEvent antimalwareEvent, string webHookPayloadUrl)
        {
            var webApiClient = new WebApiClient();
            webApiClient.Post(webHookPayloadUrl, antimalwareEvent);
        }
        private void PushNotificationViaSignalR(AntimalwareEvent antimalwareEvent, string signalRClientId)
        {
            var hub = new AntimalwareHub();
            hub.PushNotification(antimalwareEvent);
        }
        private string GetFilePath()
        {
            return Path.Combine(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), REPO_FILE_NAME);
        }
        private void TryCreateRepositoryFile()
        {
            if (File.Exists(GetFilePath()))
                return;

            File.Create(GetFilePath()).Close();
            File.WriteAllText(GetFilePath(), "[]");
        }
        private void PersistEvent(AntimalwareEvent antimalwareEvent)
        {
            try
            {
                TryCreateRepositoryFile();

                List<AntimalwareEvent> result;
                using (FileStream stream = File.OpenRead(GetFilePath()))
                    result = SimpleJsonSerializer.Deserialize<List<AntimalwareEvent>>(stream);

                result.Add(antimalwareEvent);

                using (FileStream stream = File.OpenWrite(GetFilePath()))
                    SimpleJsonSerializer.Serialize(stream, result);
            }
            catch (Exception e)
            {
                _logger.Error(e.Message, e);
                throw e;
            }
        }

        public void ConsumeEvent(AntimalwareEvent antimalwareEvent)
        {
            _logger.InfoFormat("New event: '{0}'", antimalwareEvent.Message);

            // persist if there is no one to push the event to
            if (PushNotificationSlot == null)
            {
                PersistEvent(antimalwareEvent);
            }
            else if (PushNotificationSlot.PushNotificationType == PushNotificationType.SignalR)
            {
                PushNotificationViaSignalR(antimalwareEvent, PushNotificationSlot.SignalRClientId);
            }
            else if (PushNotificationSlot.PushNotificationType == PushNotificationType.WebHook)
            {
                PushNotificationViaWebHook(antimalwareEvent, PushNotificationSlot.WebHookPayloadUrl);
            }
        }
        public AntimalwareEvent[] ConsumePersistedEvents()
        {
            var ret = new AntimalwareEvent[0];
            try
            {
                TryCreateRepositoryFile();

                using (FileStream stream = File.OpenRead(GetFilePath()))
                    ret = SimpleJsonSerializer.Deserialize<AntimalwareEvent[]>(stream);

                File.WriteAllText(GetFilePath(), "[]");
            }
            catch (Exception e)
            {
                _logger.Error(e.Message, e);
                throw e;
            }

            return ret;
        }
    }
}
