using DRadoaica.Antimalware.SDK.Infrastructure.IoC;
using DRadoaica.Antimalware.SDK.Models;
using Microsoft.AspNet.SignalR;
using Unity;

namespace DRadoaica.Antimalware.SDK.Api
{
    public class AntimalwareHub : Hub
    {
        private IoCContainerWrapper _ioCContainerWrapper;
        private IAntimalware _antimalware;
        private IAntimalwareConsumer _antimalwareConsumer;

        private IoCContainerWrapper IoCContainerWrapper => _ioCContainerWrapper ?? (_ioCContainerWrapper = new IoCContainerWrapper());
        private IAntimalware Antimalware => _antimalware ?? (_antimalware = (IAntimalware)IoCContainerWrapper.IocContainer.Resolve(typeof(IAntimalware)));
        private IAntimalwareConsumer AntimalwareConsumer => _antimalwareConsumer ?? (_antimalwareConsumer = (IAntimalwareConsumer)IoCContainerWrapper.IocContainer.Resolve(typeof(IAntimalwareConsumer)));

        public void EnableScanning()
        {
            Antimalware.EnableScanning();
        }
        public void DisableScanning()
        {
            Antimalware.DisableScanning();
        }
        public StartScanResult StartScan()
        {
            return Antimalware.StartScan();
        }
        public StopScanResult StopScan()
        {
            return Antimalware.StopScan();
        }
        public void AddSignalRClient(string id)
        {
            AntimalwareConsumer.PushNotificationSlot = new PushNotificationSlot
            {
                PushNotificationType = PushNotificationType.SignalR,
                SignalRClientId = id
            };
        }
        public void DeleteSignalRClient()
        {
            AntimalwareConsumer.PushNotificationSlot = null;
        }
        public AntimalwareEvent[] ConsumePersistedEvents()
        {
            return AntimalwareConsumer.ConsumePersistedEvents();
        }
        public void PushNotification(AntimalwareEvent antimalwareEvent)
        {
            IHubContext ctx = GlobalHost.ConnectionManager.GetHubContext<AntimalwareHub>();

            ctx.Clients.Client(AntimalwareConsumer.PushNotificationSlot.SignalRClientId).PushNotification(antimalwareEvent);
        }
    }
}
