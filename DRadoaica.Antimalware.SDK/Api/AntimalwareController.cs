using DRadoaica.Antimalware.SDK.Models;
using Swashbuckle.Swagger.Annotations;
using System.Net;
using System.Web.Http;

namespace DRadoaica.Antimalware.SDK.Api
{
    [RoutePrefix("api/antimalware")]
    public class AntimalwareController : ApiController
    {
        private IAntimalware _antimalware;
        private IAntimalwareConsumer _antimalwareConsumer;

        public AntimalwareController(IAntimalware antimalware, IAntimalwareConsumer antimalwareConsumer)
        {
            _antimalware = antimalware;
            _antimalwareConsumer = antimalwareConsumer;
        }

        [HttpPost]
        [Route("enablesscanning")]
        [SwaggerResponse(HttpStatusCode.OK)]
        [SwaggerResponse(HttpStatusCode.InternalServerError)]
        public IHttpActionResult EnableScanning()
        {
            try
            {
                _antimalware.EnableScanning();

                return Ok();
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpPost]
        [Route("disablescanning")]
        [SwaggerResponse(HttpStatusCode.OK)]
        [SwaggerResponse(HttpStatusCode.InternalServerError)]
        public IHttpActionResult DisableScanning()
        {
            try
            {
                _antimalware.DisableScanning();

                return Ok();
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpPost]
        [Route("startscan")]
        [SwaggerResponse(HttpStatusCode.OK, null, typeof(StartScanResult))]
        [SwaggerResponse(HttpStatusCode.InternalServerError, null, typeof(StartScanResult))]
        public IHttpActionResult StartScan()
        {
            try
            {
                StartScanResult ret = _antimalware.StartScan();

                if (ret.IsError)
                {
                    return Content(HttpStatusCode.InternalServerError, ret);
                }
                else
                {
                    return Ok(ret);
                }
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpPost]
        [Route("stopscan")]
        [SwaggerResponse(HttpStatusCode.OK, null, typeof(StopScanResult))]
        [SwaggerResponse(HttpStatusCode.InternalServerError, null, typeof(StopScanResult))]
        public IHttpActionResult StopScan()
        {
            try
            {
                StopScanResult ret = _antimalware.StopScan();

                if (ret.IsError)
                {
                    return Content(HttpStatusCode.InternalServerError, ret);
                }
                else
                {
                    return Ok(ret);
                }
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpPost]
        [Route("addwebhook")]
        [SwaggerResponse(HttpStatusCode.OK)]
        [SwaggerResponse(HttpStatusCode.InternalServerError)]
        public IHttpActionResult AddWebHook([FromUri] string payloadUrl)
        {
            try
            {
                _antimalwareConsumer.PushNotificationSlot = new PushNotificationSlot
                {
                    PushNotificationType = PushNotificationType.WebHook,
                    WebHookPayloadUrl = payloadUrl
                };

                return Ok();
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpDelete]
        [Route("deletewebhook")]
        [SwaggerResponse(HttpStatusCode.OK)]
        [SwaggerResponse(HttpStatusCode.InternalServerError)]
        public IHttpActionResult DeleteWebHook()
        {
            try
            {
                _antimalwareConsumer.PushNotificationSlot = null;

                return Ok();
            }
            catch
            {
                return InternalServerError();
            }
        }
        [HttpGet]
        [Route("consumepersistedevents")]
        [SwaggerResponse(HttpStatusCode.OK, null, typeof(AntimalwareEvent[]))]
        [SwaggerResponse(HttpStatusCode.InternalServerError)]
        public IHttpActionResult ConsumePersistedEvents()
        {
            try
            {
                AntimalwareEvent[] ret = _antimalwareConsumer.ConsumePersistedEvents();

                return Ok(ret);
            }
            catch
            {
                return InternalServerError();
            }
        }
    }
}
